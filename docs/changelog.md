# Changelog

## 2026-02-17
- Added `services/api` TypeScript Express service scaffold.
- Implemented endpoints: `/health`, `/auth/signup`, `/auth/login`, `/topics`, `/subscriptions` (GET/POST).
- Added JWT middleware and password hashing.
- Added SQL migration runner and initial migration (`001_init.sql`).
- Added checkpoint documentation:
  - `docs/decisions.md`
  - `docs/api-contract.md`
  - `docs/db-schema.md`
  - `docs/runbook.md`

- Added `docs/implementation-next-steps.md` with status, pending items, and milestone plan.
- Added subscription update/deactivate endpoints (`PATCH /subscriptions/:id`, `DELETE /subscriptions/:id`).
- Added request logging middleware with per-request id.
- Added centralized error middleware and standardized error response shape.
- Added auth route in-memory rate limiting (signup/login).
- Added integration test suite for auth + subscription lifecycle.
- Added migration `002_content_pipeline.sql` for source/article/digest/email pipeline tables.
- Added `services/ingestion` service scaffold with RSS fetch, normalization, hashing, and persistence.
- Added root scripts for ingestion build/run (`dev:ingestion`, `build:ingestion`, `run:ingestion:once`).
- Updated README, runbook, and schema docs for ingestion and new DB model.
- Added `services/digest-worker` service scaffold for subscription-based digest generation.
- Added digest ranking logic (topic confidence + recency) and persistence to `digests`/`digest_items`.
- Added root scripts for digest build/run (`dev:digest`, `build:digest`, `run:digest:once`).
- Updated runbook/env/README and implementation status docs for digest worker.
- Added `docs/completion-summary.md` documenting completed milestones and validation outcomes through digest generation.
- Added `services/email-worker` service scaffold for pending digest delivery via SMTP (MailHog local).
- Added email payload rendering (text + HTML), digest status updates (`pending -> sent/failed`), and `email_events` persistence.
- Added root scripts for email worker (`dev:email`, `build:email`, `run:email:once`).
- Updated env template, README, runbook, and implementation status docs for email worker milestone.
- Added `scripts/pipeline-e2e.sh` to run ingestion -> digest -> email sequence with DB assertions.
- Added root command `npm run pipeline:e2e` for one-command pipeline validation.
- Updated README/runbook/next-steps docs to include e2e pipeline workflow.
- Added `docs/production-hardening-checklist.md` to track queueing, observability, layering, and production readiness tasks.
- Added API `/metrics` endpoint and enriched `/health` payload with uptime/timestamp.
- Added worker observability endpoints (`/health`, `/metrics`) for ingestion, digest, and email workers.
- Refactored API auth flow into repository/service layers (`user-repository`, `auth-service`).
- Upgraded email worker to PostgreSQL queue-backed delivery with retries and exponential backoff.
- Added migration `003_email_jobs_queue.sql` introducing `email_jobs` for queue-backed email processing.
- Refactored topics/subscriptions API routes to service/repository layers (`topic-service`, `subscription-service`, related repositories).
- Added email queue integration test (`services/email-worker/src/__tests__/queue.integration.test.ts`).
- Added root script `npm run test:email` for email-worker queue test flow.
- Added digest history API endpoint `GET /digests` (authenticated).
- Added repository/service layering for digest/topic/subscription routes.
- Added `apps/web` MVP (signup/login, subscriptions management, digest history).
- Added root command `npm run dev:web`.
- Added admin API endpoints (`/admin/overview`, `/admin/sources`, `/admin/digests`, `/admin/email-jobs`, `/admin/email-events`).
- Added `apps/admin` MVP dashboard with login, overview cards, source/digest/email operational tables.
- Added root command `npm run dev:admin`.

## 2026-02-18
- Added migration `004_user_roles_unsubscribe.sql` introducing:
  - `users.role` (`user|admin`)
  - `users.email_opt_out`, `users.email_opt_out_at`
- Added admin role enforcement middleware (`requireAdmin`) across `/admin/*` endpoints.
- Added unsubscribe endpoints:
  - `POST /unsubscribe/request`
  - `POST /unsubscribe/confirm`
  - `GET /unsubscribe/confirm?token=...`
- Added signed unsubscribe token utilities in API and email worker.
- Added unsubscribe audit logging to `email_events` (`event_type='unsubscribed'`).
- Updated digest and email workers to suppress opted-out users from new digest sends.
- Added unsubscribe link rendering in digest email text/HTML templates.
- Expanded API integration tests with:
  - admin RBAC access control coverage
  - unsubscribe request/confirm coverage
- Expanded email worker integration tests with opted-out enqueue suppression coverage.
